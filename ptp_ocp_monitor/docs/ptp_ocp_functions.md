# Функции драйвера PTP OCP

Этот документ описывает основные функции драйвера `ptp_ocp`, которые мониторятся системой.

## Основные PTP операции

### ptp_ocp_gettimex()
```c
static int ptp_ocp_gettimex(struct ptp_clock_info *ptp_info, struct timespec64 *ts,
                           struct ptp_system_timestamp *sts)
```
- **Описание**: Получает текущее время из PTP часов
- **Частота вызовов**: Высокая (может вызываться несколько раз в секунду)
- **Важность**: Критическая - основная функция для чтения времени
- **Регистры**: Читает `time_sec` и `time_ns`

### ptp_ocp_settime()
```c
static int ptp_ocp_settime(struct ptp_clock_info *ptp_info, const struct timespec64 *ts)
```
- **Описание**: Устанавливает время в PTP часах
- **Частота вызовов**: Низкая (обычно при инициализации или ручной настройке)
- **Важность**: Критическая - устанавливает базовое время
- **Регистры**: Записывает в `adjust_sec`, `adjust_ns` и `ctrl`

### ptp_ocp_adjtime()
```c
static int ptp_ocp_adjtime(struct ptp_clock_info *ptp_info, s64 delta_ns)
```
- **Описание**: Корректирует время на заданную дельту
- **Частота вызовов**: Средняя (при синхронизации)
- **Важность**: Высокая - используется для подстройки времени
- **Особенности**: Использует разные методы для больших и малых корректировок

### ptp_ocp_adjfine()
```c
static int ptp_ocp_adjfine(struct ptp_clock_info *ptp_info, long scaled_ppm)
```
- **Описание**: Точная подстройка частоты часов
- **Частота вызовов**: Средняя (при работе PTP servo)
- **Важность**: Высокая - поддерживает точность синхронизации
- **Регистры**: Записывает в `drift_ns` и `drift_window_ns`

## Управление временными метками

### ptp_ocp_ts_enable()
```c
static int ptp_ocp_ts_enable(void *priv, struct ptp_clock_request *rq, int on)
```
- **Описание**: Включает/выключает захват временных меток
- **Частота вызовов**: Низкая (при конфигурации)
- **Важность**: Средняя - управляет функциями timestamping
- **Типы**: Поддерживает EXTTS (внешние метки) и PEROUT (периодический выход)

### ptp_ocp_ts_irq()
- **Описание**: Обработчик прерываний для временных меток
- **Частота вызовов**: Зависит от входных событий
- **Важность**: Высокая - обрабатывает события в реальном времени
- **Действия**: Читает метки времени и генерирует PTP события

## Управление сигналами

### ptp_ocp_signal_enable()
```c
static int ptp_ocp_signal_enable(void *priv, struct ptp_clock_request *rq, int on)
```
- **Описание**: Управляет выходными сигналами (генераторами)
- **Частота вызовов**: Низкая (при конфигурации)
- **Важность**: Средняя - настраивает выходные сигналы
- **Параметры**: Период, длительность импульса, полярность

### ptp_ocp_signal_from_perout()
- **Описание**: Конвертирует PEROUT запрос в конфигурацию сигнала
- **Частота вызовов**: Низкая
- **Важность**: Средняя - вспомогательная функция

## SMA (SubMiniature version A) интерфейс

### ptp_ocp_sma_store()
```c
static int ptp_ocp_sma_store(struct ptp_ocp *bp, const char *buf, int sma_nr)
```
- **Описание**: Записывает конфигурацию SMA разъема
- **Частота вызовов**: Низкая (при изменении конфигурации)
- **Важность**: Высокая - определяет маршрутизацию сигналов
- **Функции SMA**:
  - Вход/выход 10MHz
  - Вход/выход PPS
  - IRIG-B
  - DCF77
  - Частотные входы

### ptp_ocp_sma_show()
```c
static ssize_t ptp_ocp_sma_show(struct ptp_ocp *bp, int sma_nr, char *buf,
                               int default_in_val, int default_out_val)
```
- **Описание**: Читает текущую конфигурацию SMA
- **Частота вызовов**: Низкая (при чтении sysfs)
- **Важность**: Средняя - информационная функция

## Управление устройством

### ptp_ocp_probe()
```c
static int ptp_ocp_probe(struct pci_dev *pdev, const struct pci_device_id *id)
```
- **Описание**: Инициализация устройства при обнаружении
- **Частота вызовов**: Однократно при загрузке
- **Важность**: Критическая - инициализирует все подсистемы
- **Действия**:
  - Выделение ресурсов
  - Маппинг регистров
  - Регистрация PTP clock
  - Инициализация подсистем

### ptp_ocp_remove()
```c
static void ptp_ocp_remove(struct pci_dev *pdev)
```
- **Описание**: Освобождение ресурсов при удалении устройства
- **Частота вызовов**: Однократно при выгрузке
- **Важность**: Критическая - корректное завершение работы

### ptp_ocp_watchdog()
```c
static void ptp_ocp_watchdog(struct timer_list *t)
```
- **Описание**: Периодическая проверка состояния устройства
- **Частота вызовов**: Каждые 500мс (по умолчанию)
- **Важность**: Высокая - мониторинг состояния
- **Проверки**:
  - Статус GNSS
  - Синхронизация часов
  - Состояние TOD

### ptp_ocp_read_eeprom()
```c
static void ptp_ocp_read_eeprom(struct ptp_ocp *bp)
```
- **Описание**: Чтение конфигурации из EEPROM
- **Частота вызовов**: При инициализации
- **Важность**: Средняя - загружает сохраненные настройки
- **Данные**: Серийный номер, MAC адрес, калибровочные данные

## Регистрация подсистем

### ptp_ocp_register_ext()
- **Описание**: Регистрирует внешние источники временных меток
- **Важность**: Высокая - настраивает входы/выходы

### ptp_ocp_register_i2c()
- **Описание**: Регистрирует I2C контроллеры
- **Важность**: Средняя - для управления внешними устройствами

### ptp_ocp_register_spi()
- **Описание**: Регистрирует SPI контроллер
- **Важность**: Средняя - для доступа к flash памяти

### ptp_ocp_register_serial()
- **Описание**: Регистрирует последовательные порты
- **Важность**: Высокая - для GNSS, MAC, NMEA

## TOD (Time of Day) функции

### ptp_ocp_tod_init()
- **Описание**: Инициализация TOD подсистемы
- **Важность**: Средняя - настраивает протоколы времени

### ptp_ocp_tod_info()
- **Описание**: Получение информации о TOD
- **Важность**: Низкая - информационная функция

## Специфичные для плат функции

### ptp_ocp_fb_board_init()
- **Описание**: Инициализация для Facebook Time Card
- **Важность**: Высокая для конкретной платы

### ptp_ocp_art_board_init()
- **Описание**: Инициализация для ART Card
- **Важность**: Высокая для конкретной платы

## Вспомогательные функции

### ptp_ocp_adjtime_coarse()
- **Описание**: Грубая корректировка времени (> 1 секунды)
- **Важность**: Средняя - для больших корректировок

### ptp_ocp_enable_fpga()
- **Описание**: Управление битами в FPGA регистрах
- **Важность**: Низкая - вспомогательная функция

### ptp_ocp_init_clock()
- **Описание**: Базовая инициализация часов
- **Важность**: Высокая при старте

## Частота вызовов и производительность

### Высокочастотные операции (> 1 Гц):
- `ptp_ocp_gettimex` - основное чтение времени
- `ptp_ocp_watchdog` - мониторинг состояния

### Среднечастотные операции (0.1-1 Гц):
- `ptp_ocp_adjtime` - корректировки времени
- `ptp_ocp_adjfine` - подстройка частоты
- `ptp_ocp_ts_irq` - обработка событий

### Низкочастотные операции (< 0.1 Гц):
- Функции конфигурации (sma_store, signal_enable)
- Инициализация (probe, register_*)
- Чтение EEPROM

## Критичность для мониторинга

### Критические функции:
1. `ptp_ocp_gettimex` - основная функция времени
2. `ptp_ocp_settime` - установка времени
3. `ptp_ocp_adjtime` - синхронизация
4. `ptp_ocp_probe/remove` - жизненный цикл

### Важные для диагностики:
1. `ptp_ocp_watchdog` - состояние устройства
2. `ptp_ocp_sma_store/show` - конфигурация
3. `ptp_ocp_ts_irq` - обработка событий

### Информационные:
1. Функции чтения атрибутов
2. TOD функции
3. EEPROM операции