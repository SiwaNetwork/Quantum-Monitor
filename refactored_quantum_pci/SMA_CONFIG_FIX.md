# Исправление настройки SMA портов в Web версии

## Проблема

Настройка SMA портов в веб-интерфейсе не работала по следующим причинам:

1. **Отсутствие устройства**: Веб-интерфейс не мог найти физическое устройство QUANTUM-PCI и работал в "ограниченном режиме" (limited mode)
2. **Хардкод опций**: В HTML были жестко заданы опции для SMA входов/выходов вместо динамической загрузки из устройства
3. **Отсутствие API endpoint**: Не было endpoint для получения доступных SMA опций

## Внесенные изменения

### 1. Добавлен тестовый режим

Создан скрипт `start_web_test.sh` для запуска веб-интерфейса с тестовым устройством:

```bash
#!/bin/bash
# Запуск веб-интерфейса с тестовым устройством
./start_web_test.sh
```

Тестовое устройство находится в директории `test_device/` и эмулирует файловую структуру реального устройства.

### 2. Добавлен API endpoint для SMA опций

В файл `src/api/web_api.py` добавлен новый endpoint:

```python
@self.app.get("/api/device/sma-options")
async def get_sma_options():
    """Получение доступных опций для SMA портов"""
    if not self.device:
        raise HTTPException(status_code=503, detail="Device not available")
    
    try:
        return {
            "available_inputs": self.device.get_available_sma_inputs(),
            "available_outputs": self.device.get_available_sma_outputs()
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 3. Обновлен JavaScript для динамической загрузки опций

В файле `web/static/js/main.js`:

- Добавлено поле `smaOptions` для хранения доступных опций
- Обновлен метод `loadInitialData()` для загрузки опций с сервера
- Обновлен метод `refreshData()` для обновления опций

### 4. Обновлен HTML для использования динамических опций

В файле `web/templates/index.html`:

- Убраны хардкод опции для SMA входов/выходов
- Добавлен динамический рендеринг опций из `smaOptions`
- Добавлена опция "None" (Не используется) для всех портов

## Как тестировать

### 1. Запуск с тестовым устройством

```bash
cd /workspace/refactored_quantum_pci
./start_web_test.sh
```

### 2. Использование тестового скрипта

```bash
# Запустите тестовый скрипт для проверки API
python test_sma_web.py
```

### 3. Проверка через веб-интерфейс

1. Откройте браузер и перейдите на http://localhost:8000
2. Перейдите в раздел "Настройка SMA портов"
3. Теперь вы увидите все доступные опции из устройства:
   - **Входы**: 10Mhz, PPS1, PPS2, TS1, TS2, TS3, TS4, IRIG, DCF
   - **Выходы**: 10Mhz, PHC, MAC, PPS1, PPS2, TS1-4, IRIG, DCF, GNSS1-2, GEN1-5

### 4. Проверка сохранения настроек

После изменения настроек проверьте файлы в тестовом устройстве:

```bash
cd test_device
cat sma1      # для входа SMA1
cat sma1_out  # для выхода SMA1
```

## Структура файлов SMA

- **Входы**: `sma1`, `sma2`, `sma3`, `sma4`
- **Выходы**: `sma1_out`, `sma2_out`, `sma3_out`, `sma4_out`
- **Доступные входы**: `available_sma_inputs`
- **Доступные выходы**: `available_sma_outputs`

## Возможные проблемы и решения

### 1. "Device not available" в API

**Причина**: Веб-сервер не может найти устройство

**Решение**: Используйте тестовый режим или укажите правильный путь к устройству:
```bash
./start_web.sh --device /path/to/device
```

### 2. Ошибка записи в файлы устройства

**Причина**: Нет прав на запись в файлы устройства

**Решение**: 
- Для тестового устройства: убедитесь, что файлы имеют права на запись
- Для реального устройства: запустите с правами суперпользователя или настройте права доступа

### 3. Опции не отображаются в интерфейсе

**Причина**: JavaScript не может загрузить опции с сервера

**Решение**: 
- Проверьте консоль браузера на наличие ошибок
- Убедитесь, что API endpoint `/api/device/sma-options` работает
- Проверьте, что устройство доступно

## Дальнейшие улучшения

1. Добавить валидацию комбинаций входов/выходов
2. Добавить визуальную индикацию текущего состояния портов
3. Добавить возможность сброса к настройкам по умолчанию
4. Добавить историю изменений конфигурации
5. Добавить экспорт/импорт конфигурации